{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "db0a0808",
   "metadata": {},
   "source": [
    "# Проект разработки витрины для маркетплейса\n",
    "\n",
    "## Задачи: \n",
    "- Построить с помощью SQL витрину клиентских данных product_user_features, используя информацию о заказах пользователей. Витрина должна содержать информацию о заказах каждого клиента с учётом его региона.\n",
    "- Решить четыре ad hoc задачи на исследование данных в витрине и сформулировать по каждой из них выводы, которые следуют из полученных результатов.\n",
    "\n",
    "## Описание данных:\n",
    "\n",
    "Таблица orders — информация о заказах. Содержит поля:\n",
    "- order_id — идентификатор заказа.\n",
    "- buyer_id — идентификатор покупателя, то есть номер пользователя при оформлении конкретного заказа.\n",
    "- order_status — статус заказа (Доставлен, В процессе и так далее).\n",
    "- order_purchase_ts — время покупки.\n",
    "- order_approved_at — время подтверждения заказа.\n",
    "- order_delivered_carrier_ts — время передачи заказа в службу доставки.\n",
    "- order_delivered_ts — время доставки заказа покупателю.\n",
    "- order_estimated_delivery_dt — ожидаемая дата доставки заказа.\n",
    "\n",
    "Таблица order_items — информация о товарах, которые входят в заказ. Содержит поля:\n",
    "- order_id — идентификатор заказа.\n",
    "- order_item_id — позиция товара в заказе (первая, вторая и так далее).\n",
    "- product_id — идентификатор товара.\n",
    "- seller_id — идентификатор продавца, который продаёт этот товар.\n",
    "- shipping_limit_date — дата, до которой товар должен быть доставлен.\n",
    "- price — цена товара.\n",
    "- delivery_cost — стоимость доставки товара.\n",
    "\n",
    "Таблица order_payments  — информация о способах оплаты заказов.Содержит поля:\n",
    "- order_id — идентификатор заказа.\n",
    "- payment_sequential — порядковый номер платежа.\n",
    "- payment_type — тип оплаты в платеже (например, банковская карта, промокод, оплата по счёту и так далее).\n",
    "- payment_installments — количество рассрочек платежа (1 — платёж совершён в полном объёме).\n",
    "\n",
    "Таблица order_reviews — отзывы о заказах, оставленные покупателями. Содержит поля:\n",
    "- review_id — идентификатор отзыва.\n",
    "- order_id — идентификатор заказа, к которому относится отзыв.\n",
    "- review_score — оценка заказа, от 1 до 5.\n",
    "- review_creation_date — дата создания отзыва.\n",
    "- review_answer_timestamp — время ответа продавца на отзыв.\n",
    "\n",
    "Таблица users — информация о покупателях.Содержит поля:\n",
    "- buyer_id — идентификатор покупателя, то есть номер пользователя при оформлении конкретного заказа.\n",
    "- user_id — уникальный идентификатор пользователя.\n",
    "- region — регион совершения покупки.\n",
    "- zip_code_prefix — индекс региона совершения покупки."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "f662371e",
   "metadata": {},
   "source": [
    "## Зависимости данных вы можете увидеть на ER-диаграмме:\n",
    "\n",
    "![](https://pictures.s3.yandex.net/resources/PPROD-15191_scheme_1752834421.png)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "92759f5c",
   "metadata": {},
   "source": [
    "# Разработка витрины данных"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "9346a360",
   "metadata": {},
   "outputs": [],
   "source": [
    "WITH payments AS\n",
    "  (SELECT op.order_id,\n",
    "          op.payment_sequential,\n",
    "          op.payment_type,\n",
    "          op.payment_installments\n",
    "   FROM ds_ecom.order_payments op),\n",
    "\n",
    "-- первый тип оплаты в заказе\n",
    "first_payment AS\n",
    "  (SELECT order_id,\n",
    "          payment_type AS first_payment_type\n",
    "   FROM\n",
    "     (SELECT order_id,\n",
    "             payment_type,\n",
    "             ROW_NUMBER() OVER (PARTITION BY order_id\n",
    "                                ORDER BY payment_sequential) AS rn\n",
    "      FROM payments) t\n",
    "   WHERE rn = 1),\n",
    "\n",
    "-- признак промо\n",
    "order_promo AS\n",
    "  (SELECT order_id,\n",
    "          CASE WHEN COUNT(*) FILTER (\n",
    "                                    WHERE payment_type = 'промокод') > 0 THEN 1\n",
    "              ELSE 0\n",
    "          END AS used_promo_in_order\n",
    "   FROM payments\n",
    "   GROUP BY order_id),\n",
    "\n",
    "-- признак рассрочки\n",
    "order_installments AS\n",
    "  (SELECT order_id,\n",
    "          CASE\n",
    "              WHEN MAX(payment_installments) > 1 THEN 1\n",
    "              ELSE 0\n",
    "          END AS used_installments_in_order\n",
    "   FROM payments\n",
    "   GROUP BY order_id),\n",
    "\n",
    "-- собираем признаки на уровне заказа\n",
    "order_level AS\n",
    "  (SELECT fp.order_id,\n",
    "          fp.first_payment_type,\n",
    "          opm.used_promo_in_order,\n",
    "          oi.used_installments_in_order\n",
    "   FROM first_payment fp\n",
    "   JOIN order_promo opm USING (order_id)\n",
    "   JOIN order_installments oi USING (order_id)),\n",
    "\n",
    "-- стоимость каждого заказа\n",
    "orders_price AS\n",
    "  (SELECT o.order_id,\n",
    "          sum(oi.price) + sum(oi.delivery_cost) AS total_price\n",
    "   FROM ds_ecom.orders o\n",
    "   JOIN ds_ecom.order_items oi USING (order_id)\n",
    "   WHERE order_status = 'Доставлено'\n",
    "   GROUP BY o.order_id),\n",
    "\n",
    "-- предварительные расчеты под оценки\n",
    "reviews_numbers AS\n",
    "  (SELECT o.order_id,\n",
    "          sum(CASE\n",
    "                  WHEN ore.review_score > 5 THEN ore.review_score / 10\n",
    "                  ELSE ore.review_score\n",
    "              END) AS total_score,\n",
    "          count(ore.review_score) AS count_review\n",
    "   FROM ds_ecom.orders o\n",
    "   JOIN ds_ecom.order_reviews ore USING(order_id)\n",
    "   WHERE order_status = 'Доставлено' OR order_status = 'Отменено'\n",
    "   GROUP BY o.order_id\n",
    "   ORDER BY count_review DESC),\n",
    "\n",
    "-- средняя оценка по заказам\n",
    "order_avg_score AS\n",
    "  (SELECT order_id,\n",
    "          total_score::float / count_review::float AS avg_review_score\n",
    "   FROM reviews_numbers),\n",
    "\n",
    "-- сводим все признаки по заказам\n",
    "orders_finals AS\n",
    "  (SELECT ol.order_id,\n",
    "          ol.first_payment_type,\n",
    "          ol.used_promo_in_order,\n",
    "          ol.used_installments_in_order,\n",
    "          op.total_price,\n",
    "          oas.avg_review_score\n",
    "   FROM order_level ol\n",
    "   LEFT JOIN order_avg_score oas USING (order_id)\n",
    "   LEFT JOIN orders_price op USING (order_id)),\n",
    "\t\t\t\t\t\t \n",
    "-- топ 3 региона\n",
    "top_regions AS\n",
    "  (SELECT u.region,\n",
    "          count(o.order_id) AS cnt\n",
    "   FROM ds_ecom.users u\n",
    "   JOIN ds_ecom.orders o USING (buyer_id)\n",
    "   GROUP BY u.region\n",
    "   ORDER BY cnt DESC\n",
    "   LIMIT 3),\n",
    "\t\t\n",
    "-- начинаем сводить инфу по парам юзер/регион\n",
    "usreg_time_orders AS\n",
    "  (SELECT u.region,\n",
    "          u.user_id,\n",
    "          min(o.order_purchase_ts) AS first_order_ts,\n",
    "          max(o.order_purchase_ts) AS last_order_ts,\n",
    "          max(o.order_purchase_ts) - min(o.order_purchase_ts) AS lifetime,\n",
    "          count(of.order_id) AS total_orders,\n",
    "          avg(of.avg_review_score) AS avg_order_rating,\n",
    "          count(oas.order_id) AS num_orders_with_rating,\n",
    "          sum(of.total_price) AS total_order_costs,\n",
    "          avg(of.total_price) AS avg_order_cost,\n",
    "          sum(of.used_installments_in_order) AS num_installment_orders,\n",
    "          sum(OF.used_promo_in_order) AS num_orders_with_promo,\n",
    "          sum(of.used_installments_in_order) AS sum_installments\n",
    "   FROM ds_ecom.users u\n",
    "   JOIN ds_ecom.orders o USING (buyer_id)\n",
    "   JOIN orders_finals OF ON o.order_id = OF.order_id\n",
    "   LEFT JOIN order_avg_score oas ON of.order_id = oas.order_id\n",
    "   WHERE o.order_status = 'Доставлено'\n",
    "     OR o.order_status = 'Отменено'\n",
    "   GROUP BY u.region,\n",
    "            u.user_id\n",
    "   HAVING u.region IN\n",
    "     (SELECT region\n",
    "      FROM top_regions)),\n",
    "\n",
    "-- количество отмененных заказов\n",
    "canceled_orders_count AS\n",
    "  (SELECT u.region,\n",
    "          u.user_id,\n",
    "          count(*) AS num_canceled_orders\n",
    "   FROM ds_ecom.users u\n",
    "   JOIN ds_ecom.orders o USING (buyer_id)\n",
    "   WHERE o.order_status = 'Отменено'\n",
    "   GROUP BY u.region,\n",
    "            u.user_id),\n",
    "\n",
    "-- делаем флаг под использование денежного перевода\n",
    "money_flg AS\n",
    "  (SELECT u.user_id,\n",
    "          u.region,\n",
    "          CASE\n",
    "              WHEN ol.first_payment_type = 'денежный перевод' THEN 1\n",
    "              ELSE 0\n",
    "          END AS money_flag\n",
    "   FROM ds_ecom.users u\n",
    "   JOIN ds_ecom.orders o USING (buyer_id)\n",
    "   JOIN order_level ol ON o.order_id = ol.order_id),\n",
    "   \n",
    "used_money_transfer AS\n",
    "  (SELECT mf.user_id,\n",
    "          mf.region,\n",
    "          CASE\n",
    "              WHEN sum(mf.money_flag) > 0 THEN 1\n",
    "              ELSE 0\n",
    "          END AS used_money_transfer\n",
    "   FROM money_flg mf\n",
    "   GROUP BY mf.user_id,\n",
    "            mf.region)\n",
    "\n",
    "-- витрина финальная\n",
    "SELECT uto.user_id,\n",
    "       uto.region,\n",
    "       uto.first_order_ts,\n",
    "       uto.last_order_ts,\n",
    "       uto.lifetime,\n",
    "       uto.total_orders,\n",
    "       COALESCE(uto.avg_order_rating, 0) AS avg_order_rating,\n",
    "       uto.num_orders_with_rating,\n",
    "       COALESCE(coc.num_canceled_orders, 0) AS num_canceled_orders,\n",
    "       COALESCE(coc.num_canceled_orders, 0)::float / uto.total_orders::float AS canceled_orders_ratio,\n",
    "       COALESCE(uto.total_order_costs, 0) AS total_order_costs,\n",
    "       round(COALESCE(uto.avg_order_cost, 0), 2) AS avg_order_cost,\n",
    "       uto.num_installment_orders,\n",
    "       uto.num_orders_with_promo,\n",
    "       umt.used_money_transfer,\n",
    "       CASE\n",
    "           WHEN uto.sum_installments > 0 THEN 1\n",
    "           ELSE 0\n",
    "       END AS used_installments,\n",
    "       CASE\n",
    "           WHEN coc.num_canceled_orders > 0 THEN 1\n",
    "           ELSE 0\n",
    "       END AS used_cancel\n",
    "FROM usreg_time_orders uto\n",
    "LEFT JOIN canceled_orders_count coc ON uto.user_id = coc.user_id\n",
    "AND uto.region = coc.region\n",
    "LEFT JOIN used_money_transfer umt ON uto.user_id = umt.user_id\n",
    "AND uto.region = umt.region"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "4142b430",
   "metadata": {},
   "source": [
    "## Пример первых 10 записей с витрины данных"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "8244366e",
   "metadata": {},
   "outputs": [],
   "source": [
    "import pandas as pd\n",
    "import numpy as np"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "0ba2c18d",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>user_id</th>\n",
       "      <th>region</th>\n",
       "      <th>first_order_ts</th>\n",
       "      <th>last_order_ts</th>\n",
       "      <th>lifetime</th>\n",
       "      <th>total_orders</th>\n",
       "      <th>avg_order_rating</th>\n",
       "      <th>num_orders_with_rating</th>\n",
       "      <th>num_canceled_orders</th>\n",
       "      <th>canceled_orders_ratio</th>\n",
       "      <th>total_order_costs</th>\n",
       "      <th>avg_order_cost</th>\n",
       "      <th>num_installment_orders</th>\n",
       "      <th>num_orders_with_promo</th>\n",
       "      <th>used_money_transfer</th>\n",
       "      <th>used_installments</th>\n",
       "      <th>used_cancel</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>c79346a04ff9e3c861f7df7e50c6c523</td>\n",
       "      <td>Москва</td>\n",
       "      <td>2024-02-12 09:16:15.000</td>\n",
       "      <td>2024-02-12 09:16:15.000</td>\n",
       "      <td>00:00:00</td>\n",
       "      <td>1</td>\n",
       "      <td>5.0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>840.0</td>\n",
       "      <td>840.0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>8b8a28ea9c0d1b98fb471b9d408b2b16</td>\n",
       "      <td>Москва</td>\n",
       "      <td>2023-07-04 09:40:53.000</td>\n",
       "      <td>2023-07-04 09:40:53.000</td>\n",
       "      <td>00:00:00</td>\n",
       "      <td>1</td>\n",
       "      <td>4.0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>2200.0</td>\n",
       "      <td>2200.0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>2d85f83f5d81495502e3fde6cd2c628c</td>\n",
       "      <td>Санкт-Петербург</td>\n",
       "      <td>2024-03-26 19:28:08.000</td>\n",
       "      <td>2024-03-26 19:28:08.000</td>\n",
       "      <td>00:00:00</td>\n",
       "      <td>1</td>\n",
       "      <td>5.0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>2325.0</td>\n",
       "      <td>2325.0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>e4d800060f85d896b83b4c3e3570065b</td>\n",
       "      <td>Москва</td>\n",
       "      <td>2023-09-05 14:20:41.000</td>\n",
       "      <td>2024-03-22 14:01:17.000</td>\n",
       "      <td>198 days 23:40:36</td>\n",
       "      <td>2</td>\n",
       "      <td>5.0</td>\n",
       "      <td>2</td>\n",
       "      <td>0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>4370.0</td>\n",
       "      <td>2185.0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>970f8e94d1e9ff19f5362c239c803768</td>\n",
       "      <td>Москва</td>\n",
       "      <td>2024-02-15 14:58:55.000</td>\n",
       "      <td>2024-02-15 14:58:55.000</td>\n",
       "      <td>00:00:00</td>\n",
       "      <td>1</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>1.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>875a707bdfd8d6544f1b74a123b3010b</td>\n",
       "      <td>Москва</td>\n",
       "      <td>2024-07-22 21:40:20.000</td>\n",
       "      <td>2024-07-22 21:40:20.000</td>\n",
       "      <td>00:00:00</td>\n",
       "      <td>1</td>\n",
       "      <td>3.0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>3040.0</td>\n",
       "      <td>3040.0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6</th>\n",
       "      <td>6de06281a46d0d459dbe284683e0134c</td>\n",
       "      <td>Санкт-Петербург</td>\n",
       "      <td>2024-05-10 11:18:48.000</td>\n",
       "      <td>2024-05-10 11:18:48.000</td>\n",
       "      <td>00:00:00</td>\n",
       "      <td>1</td>\n",
       "      <td>1.0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>3982.0</td>\n",
       "      <td>3982.0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7</th>\n",
       "      <td>512f0635790564850446909ce00be3df</td>\n",
       "      <td>Москва</td>\n",
       "      <td>2024-05-08 20:10:20.000</td>\n",
       "      <td>2024-05-08 20:10:20.000</td>\n",
       "      <td>00:00:00</td>\n",
       "      <td>1</td>\n",
       "      <td>5.0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>4450.0</td>\n",
       "      <td>4450.0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>fc3ae503d8cbc4c02a2d8e467b7bbfe5</td>\n",
       "      <td>Москва</td>\n",
       "      <td>2023-05-10 16:20:36.000</td>\n",
       "      <td>2023-05-10 16:20:36.000</td>\n",
       "      <td>00:00:00</td>\n",
       "      <td>1</td>\n",
       "      <td>1.0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>2860.0</td>\n",
       "      <td>2860.0</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>9</th>\n",
       "      <td>eede3c924dcfa1c4340e70b50010be26</td>\n",
       "      <td>Санкт-Петербург</td>\n",
       "      <td>2024-05-30 18:09:10.000</td>\n",
       "      <td>2024-05-30 18:09:10.000</td>\n",
       "      <td>00:00:00</td>\n",
       "      <td>1</td>\n",
       "      <td>0.0</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>2320.0</td>\n",
       "      <td>2320.0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "                            user_id           region           first_order_ts  \\\n",
       "0  c79346a04ff9e3c861f7df7e50c6c523           Москва  2024-02-12 09:16:15.000   \n",
       "1  8b8a28ea9c0d1b98fb471b9d408b2b16           Москва  2023-07-04 09:40:53.000   \n",
       "2  2d85f83f5d81495502e3fde6cd2c628c  Санкт-Петербург  2024-03-26 19:28:08.000   \n",
       "3  e4d800060f85d896b83b4c3e3570065b           Москва  2023-09-05 14:20:41.000   \n",
       "4  970f8e94d1e9ff19f5362c239c803768           Москва  2024-02-15 14:58:55.000   \n",
       "5  875a707bdfd8d6544f1b74a123b3010b           Москва  2024-07-22 21:40:20.000   \n",
       "6  6de06281a46d0d459dbe284683e0134c  Санкт-Петербург  2024-05-10 11:18:48.000   \n",
       "7  512f0635790564850446909ce00be3df           Москва  2024-05-08 20:10:20.000   \n",
       "8  fc3ae503d8cbc4c02a2d8e467b7bbfe5           Москва  2023-05-10 16:20:36.000   \n",
       "9  eede3c924dcfa1c4340e70b50010be26  Санкт-Петербург  2024-05-30 18:09:10.000   \n",
       "\n",
       "             last_order_ts           lifetime  total_orders  avg_order_rating  \\\n",
       "0  2024-02-12 09:16:15.000           00:00:00             1               5.0   \n",
       "1  2023-07-04 09:40:53.000           00:00:00             1               4.0   \n",
       "2  2024-03-26 19:28:08.000           00:00:00             1               5.0   \n",
       "3  2024-03-22 14:01:17.000  198 days 23:40:36             2               5.0   \n",
       "4  2024-02-15 14:58:55.000           00:00:00             1               0.0   \n",
       "5  2024-07-22 21:40:20.000           00:00:00             1               3.0   \n",
       "6  2024-05-10 11:18:48.000           00:00:00             1               1.0   \n",
       "7  2024-05-08 20:10:20.000           00:00:00             1               5.0   \n",
       "8  2023-05-10 16:20:36.000           00:00:00             1               1.0   \n",
       "9  2024-05-30 18:09:10.000           00:00:00             1               0.0   \n",
       "\n",
       "   num_orders_with_rating  num_canceled_orders  canceled_orders_ratio  \\\n",
       "0                       1                    0                    0.0   \n",
       "1                       1                    0                    0.0   \n",
       "2                       1                    0                    0.0   \n",
       "3                       2                    0                    0.0   \n",
       "4                       0                    1                    1.0   \n",
       "5                       1                    0                    0.0   \n",
       "6                       1                    0                    0.0   \n",
       "7                       1                    0                    0.0   \n",
       "8                       1                    0                    0.0   \n",
       "9                       0                    0                    0.0   \n",
       "\n",
       "   total_order_costs  avg_order_cost  num_installment_orders  \\\n",
       "0              840.0           840.0                       0   \n",
       "1             2200.0          2200.0                       0   \n",
       "2             2325.0          2325.0                       1   \n",
       "3             4370.0          2185.0                       1   \n",
       "4                0.0             0.0                       0   \n",
       "5             3040.0          3040.0                       0   \n",
       "6             3982.0          3982.0                       0   \n",
       "7             4450.0          4450.0                       0   \n",
       "8             2860.0          2860.0                       1   \n",
       "9             2320.0          2320.0                       1   \n",
       "\n",
       "   num_orders_with_promo  used_money_transfer  used_installments  used_cancel  \n",
       "0                      0                    0                  0            0  \n",
       "1                      0                    1                  0            0  \n",
       "2                      0                    0                  1            0  \n",
       "3                      0                    0                  1            0  \n",
       "4                      0                    0                  0            1  \n",
       "5                      0                    1                  0            0  \n",
       "6                      0                    0                  0            0  \n",
       "7                      0                    0                  0            0  \n",
       "8                      1                    0                  1            0  \n",
       "9                      0                    0                  1            0  "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "vitrina = pd.read_csv('csv/vitrina.csv')\n",
    "display(vitrina.head(10))"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "1b6fe0a7",
   "metadata": {},
   "source": [
    "# Решение Ad-Hoc задач\n",
    "## Задача 1. Сегментация пользователей \n",
    " * Разделите пользователей на группы по количеству совершённых ими заказов.\n",
    " * Подсчитайте для каждой группы общее количество пользователей,\n",
    " * среднее количество заказов, среднюю стоимость заказа.\n",
    " \n",
    " Выделите такие сегменты:\n",
    " * 1 заказ — сегмент 1 заказ\n",
    " * от 2 до 5 заказов — сегмент 2-5 заказов\n",
    " * от 6 до 10 заказов — сегмент 6-10 заказов\n",
    " * 11 и более заказов — сегмент 11 и более заказов"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "6d801bf5",
   "metadata": {},
   "outputs": [],
   "source": [
    "WITH segmentiruem AS\n",
    "  (SELECT user_id,\n",
    "          CASE\n",
    "              WHEN total_orders > 10 THEN '11 и более заказов'\n",
    "              WHEN total_orders > 5\n",
    "                   AND total_orders < 11 THEN '6-10 заказов'\n",
    "              WHEN total_orders > 1\n",
    "                   AND total_orders < 6 THEN '2-5 заказов'\n",
    "              ELSE '1 заказ'\n",
    "          END AS segment,\n",
    "          total_orders,\n",
    "          total_order_costs\n",
    "   FROM ds_ecom.product_user_features)\n",
    "   \n",
    "SELECT segment,\n",
    "       count(user_id) AS total_users,\n",
    "       avg(total_orders) AS avg_orders,\n",
    "       avg(total_order_costs / total_orders) AS avg_costs\n",
    "FROM segmentiruem\n",
    "GROUP BY segment"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "4fe66784",
   "metadata": {},
   "source": [
    "### Результат 1 задачи"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "c501a47a",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>segment</th>\n",
       "      <th>total_users</th>\n",
       "      <th>avg_orders</th>\n",
       "      <th>avg_costs</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>6-10 заказов</td>\n",
       "      <td>5</td>\n",
       "      <td>7.000000</td>\n",
       "      <td>2772.896825</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>2-5 заказов</td>\n",
       "      <td>1934</td>\n",
       "      <td>2.091003</td>\n",
       "      <td>3056.675465</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>1 заказ</td>\n",
       "      <td>60468</td>\n",
       "      <td>1.000000</td>\n",
       "      <td>3324.077229</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>11 и более заказов</td>\n",
       "      <td>1</td>\n",
       "      <td>15.000000</td>\n",
       "      <td>1244.800000</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "              segment  total_users  avg_orders    avg_costs\n",
       "0        6-10 заказов            5    7.000000  2772.896825\n",
       "1         2-5 заказов         1934    2.091003  3056.675465\n",
       "2             1 заказ        60468    1.000000  3324.077229\n",
       "3  11 и более заказов            1   15.000000  1244.800000"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "adhoc1 = pd.read_csv('csv/adhoc1.csv')\n",
    "display(adhoc1)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "754080f4",
   "metadata": {},
   "source": [
    "### Выводы по 1 задаче\n",
    "Большинство пользователей маркетплейса совершают по 1 заказу, при этом видно что средние траты падают с количеством заказов.\n",
    "Получается ценность клиента растет за счет частоты заказов и не стоимости.  \n",
    "Основная точка роста - конвертировать \"1 заказ\" в \"2-5 заказов\"(например через ретаргет или персональные офферы после 1-го заказа)\n",
    "Для повторных покупателей работать над апселлами/бандлами чтобы растить средний чек."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "840bd635",
   "metadata": {},
   "source": [
    "## Задача 2. Ранжирование пользователей\n",
    "* Отсортируйте пользователей, сделавших 3 заказа и более, по убыванию среднего чека покупки, \n",
    "* Выведите 15 пользователей с самым большим средним чеком среди указанной группы."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "d7d923da",
   "metadata": {},
   "outputs": [],
   "source": [
    "SELECT *\n",
    "FROM ds_ecom.product_user_features\n",
    "WHERE total_orders > 2\n",
    "ORDER BY avg_order_cost DESC\n",
    "LIMIT 15"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "4e3a5d05",
   "metadata": {},
   "source": [
    "### Результат 2 задачи"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "2b9b9d09",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>user_id</th>\n",
       "      <th>region</th>\n",
       "      <th>first_order_ts</th>\n",
       "      <th>last_order_ts</th>\n",
       "      <th>lifetime</th>\n",
       "      <th>total_orders</th>\n",
       "      <th>avg_order_rating</th>\n",
       "      <th>num_orders_with_rating</th>\n",
       "      <th>num_canceled_orders</th>\n",
       "      <th>canceled_orders_ratio</th>\n",
       "      <th>total_order_costs</th>\n",
       "      <th>avg_order_cost</th>\n",
       "      <th>num_installment_orders</th>\n",
       "      <th>num_orders_with_promo</th>\n",
       "      <th>used_money_transfer</th>\n",
       "      <th>used_installments</th>\n",
       "      <th>used_cancel</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>1da09dd64e235e7c2f29a4faff33535c</td>\n",
       "      <td>Санкт-Петербург</td>\n",
       "      <td>2023-05-10 14:04:15.000</td>\n",
       "      <td>2024-01-11 11:16:49.000</td>\n",
       "      <td>245 days 21:12:34</td>\n",
       "      <td>3</td>\n",
       "      <td>3.666667</td>\n",
       "      <td>3</td>\n",
       "      <td>0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>44150.0</td>\n",
       "      <td>14716.67</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>297ec5afd18366f5ba27520cc4954151</td>\n",
       "      <td>Москва</td>\n",
       "      <td>2024-02-16 13:30:10.000</td>\n",
       "      <td>2024-05-12 21:23:13.000</td>\n",
       "      <td>86 days 07:53:03</td>\n",
       "      <td>3</td>\n",
       "      <td>5.000000</td>\n",
       "      <td>2</td>\n",
       "      <td>0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>37435.0</td>\n",
       "      <td>12478.33</td>\n",
       "      <td>2</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>cef29e793e232d30250331804cdb7000</td>\n",
       "      <td>Новосибирская область</td>\n",
       "      <td>2023-03-09 18:15:38.000</td>\n",
       "      <td>2024-01-18 19:59:07.000</td>\n",
       "      <td>315 days 01:43:29</td>\n",
       "      <td>3</td>\n",
       "      <td>5.000000</td>\n",
       "      <td>2</td>\n",
       "      <td>0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>34555.0</td>\n",
       "      <td>11518.33</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>397b44d5bb99eabf54ea9c2b41ebb905</td>\n",
       "      <td>Санкт-Петербург</td>\n",
       "      <td>2024-01-11 12:16:24.000</td>\n",
       "      <td>2024-06-17 19:21:01.000</td>\n",
       "      <td>158 days 07:04:37</td>\n",
       "      <td>4</td>\n",
       "      <td>5.000000</td>\n",
       "      <td>2</td>\n",
       "      <td>0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>43713.0</td>\n",
       "      <td>10928.25</td>\n",
       "      <td>3</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>d132b863416f85f2abb1a988ca05dd12</td>\n",
       "      <td>Москва</td>\n",
       "      <td>2023-08-14 13:42:08.000</td>\n",
       "      <td>2024-07-21 19:57:05.000</td>\n",
       "      <td>342 days 06:14:57</td>\n",
       "      <td>3</td>\n",
       "      <td>5.000000</td>\n",
       "      <td>3</td>\n",
       "      <td>0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>29114.0</td>\n",
       "      <td>9704.67</td>\n",
       "      <td>2</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>d387ea85dc301a91740e31360d355686</td>\n",
       "      <td>Москва</td>\n",
       "      <td>2024-01-23 10:24:15.000</td>\n",
       "      <td>2024-05-28 16:08:37.000</td>\n",
       "      <td>126 days 05:44:22</td>\n",
       "      <td>3</td>\n",
       "      <td>5.000000</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>27425.0</td>\n",
       "      <td>9141.67</td>\n",
       "      <td>3</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6</th>\n",
       "      <td>4e1cce07cd5937c69dacac3c8b13d965</td>\n",
       "      <td>Москва</td>\n",
       "      <td>2023-11-25 15:48:03.000</td>\n",
       "      <td>2024-07-30 16:04:45.000</td>\n",
       "      <td>248 days 00:16:42</td>\n",
       "      <td>3</td>\n",
       "      <td>3.500000</td>\n",
       "      <td>2</td>\n",
       "      <td>0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>25810.0</td>\n",
       "      <td>8603.33</td>\n",
       "      <td>3</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7</th>\n",
       "      <td>9832ae2f7d3e5fa4c7a1a06e9551bc61</td>\n",
       "      <td>Санкт-Петербург</td>\n",
       "      <td>2023-07-14 00:08:37.000</td>\n",
       "      <td>2024-04-24 23:25:11.000</td>\n",
       "      <td>285 days 23:16:34</td>\n",
       "      <td>3</td>\n",
       "      <td>2.666667</td>\n",
       "      <td>3</td>\n",
       "      <td>0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>23915.0</td>\n",
       "      <td>7971.67</td>\n",
       "      <td>2</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>fe81bb32c243a86b2f86fbf053fe6140</td>\n",
       "      <td>Москва</td>\n",
       "      <td>2023-10-22 11:29:22.000</td>\n",
       "      <td>2024-06-21 12:10:25.000</td>\n",
       "      <td>243 days 00:41:03</td>\n",
       "      <td>5</td>\n",
       "      <td>5.000000</td>\n",
       "      <td>2</td>\n",
       "      <td>0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>37983.0</td>\n",
       "      <td>7596.60</td>\n",
       "      <td>2</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>9</th>\n",
       "      <td>8961b4ca2c5aceb7a78ea72c6e0c840a</td>\n",
       "      <td>Москва</td>\n",
       "      <td>2023-11-27 22:10:49.000</td>\n",
       "      <td>2024-06-23 17:45:33.000</td>\n",
       "      <td>208 days 19:34:44</td>\n",
       "      <td>3</td>\n",
       "      <td>3.000000</td>\n",
       "      <td>2</td>\n",
       "      <td>0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>19055.0</td>\n",
       "      <td>6351.67</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>10</th>\n",
       "      <td>b2e9a05d23ea17713b5d7799f2004f8e</td>\n",
       "      <td>Москва</td>\n",
       "      <td>2024-07-26 14:26:07.000</td>\n",
       "      <td>2024-07-29 05:12:32.000</td>\n",
       "      <td>2 days 14:46:25</td>\n",
       "      <td>3</td>\n",
       "      <td>5.000000</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>18140.0</td>\n",
       "      <td>6046.67</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>11</th>\n",
       "      <td>6419a1be8feac26ec793667b71cbaeb4</td>\n",
       "      <td>Санкт-Петербург</td>\n",
       "      <td>2023-06-04 23:49:13.000</td>\n",
       "      <td>2023-12-26 14:57:27.000</td>\n",
       "      <td>204 days 15:08:14</td>\n",
       "      <td>3</td>\n",
       "      <td>5.000000</td>\n",
       "      <td>3</td>\n",
       "      <td>0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>18120.0</td>\n",
       "      <td>6040.00</td>\n",
       "      <td>3</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>12</th>\n",
       "      <td>ab243cd9e788d689cc822380f59616e1</td>\n",
       "      <td>Москва</td>\n",
       "      <td>2023-09-24 10:47:39.000</td>\n",
       "      <td>2024-02-01 09:39:48.000</td>\n",
       "      <td>129 days 22:52:09</td>\n",
       "      <td>3</td>\n",
       "      <td>4.000000</td>\n",
       "      <td>2</td>\n",
       "      <td>0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>17725.0</td>\n",
       "      <td>5908.33</td>\n",
       "      <td>2</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>13</th>\n",
       "      <td>e30b83af13d6ff0b0f427b2a67c43b39</td>\n",
       "      <td>Новосибирская область</td>\n",
       "      <td>2023-01-19 14:38:27.000</td>\n",
       "      <td>2023-11-28 10:44:35.000</td>\n",
       "      <td>312 days 20:06:08</td>\n",
       "      <td>3</td>\n",
       "      <td>4.666667</td>\n",
       "      <td>3</td>\n",
       "      <td>0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>16675.0</td>\n",
       "      <td>5558.33</td>\n",
       "      <td>3</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>14</th>\n",
       "      <td>3de0c9303f39b7ccfe69ca11aee19cc6</td>\n",
       "      <td>Москва</td>\n",
       "      <td>2024-01-19 14:06:44.000</td>\n",
       "      <td>2024-04-25 11:42:05.000</td>\n",
       "      <td>96 days 21:35:21</td>\n",
       "      <td>3</td>\n",
       "      <td>4.000000</td>\n",
       "      <td>2</td>\n",
       "      <td>0</td>\n",
       "      <td>0.0</td>\n",
       "      <td>16580.0</td>\n",
       "      <td>5526.67</td>\n",
       "      <td>3</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "                             user_id                 region  \\\n",
       "0   1da09dd64e235e7c2f29a4faff33535c        Санкт-Петербург   \n",
       "1   297ec5afd18366f5ba27520cc4954151                 Москва   \n",
       "2   cef29e793e232d30250331804cdb7000  Новосибирская область   \n",
       "3   397b44d5bb99eabf54ea9c2b41ebb905        Санкт-Петербург   \n",
       "4   d132b863416f85f2abb1a988ca05dd12                 Москва   \n",
       "5   d387ea85dc301a91740e31360d355686                 Москва   \n",
       "6   4e1cce07cd5937c69dacac3c8b13d965                 Москва   \n",
       "7   9832ae2f7d3e5fa4c7a1a06e9551bc61        Санкт-Петербург   \n",
       "8   fe81bb32c243a86b2f86fbf053fe6140                 Москва   \n",
       "9   8961b4ca2c5aceb7a78ea72c6e0c840a                 Москва   \n",
       "10  b2e9a05d23ea17713b5d7799f2004f8e                 Москва   \n",
       "11  6419a1be8feac26ec793667b71cbaeb4        Санкт-Петербург   \n",
       "12  ab243cd9e788d689cc822380f59616e1                 Москва   \n",
       "13  e30b83af13d6ff0b0f427b2a67c43b39  Новосибирская область   \n",
       "14  3de0c9303f39b7ccfe69ca11aee19cc6                 Москва   \n",
       "\n",
       "             first_order_ts            last_order_ts           lifetime  \\\n",
       "0   2023-05-10 14:04:15.000  2024-01-11 11:16:49.000  245 days 21:12:34   \n",
       "1   2024-02-16 13:30:10.000  2024-05-12 21:23:13.000   86 days 07:53:03   \n",
       "2   2023-03-09 18:15:38.000  2024-01-18 19:59:07.000  315 days 01:43:29   \n",
       "3   2024-01-11 12:16:24.000  2024-06-17 19:21:01.000  158 days 07:04:37   \n",
       "4   2023-08-14 13:42:08.000  2024-07-21 19:57:05.000  342 days 06:14:57   \n",
       "5   2024-01-23 10:24:15.000  2024-05-28 16:08:37.000  126 days 05:44:22   \n",
       "6   2023-11-25 15:48:03.000  2024-07-30 16:04:45.000  248 days 00:16:42   \n",
       "7   2023-07-14 00:08:37.000  2024-04-24 23:25:11.000  285 days 23:16:34   \n",
       "8   2023-10-22 11:29:22.000  2024-06-21 12:10:25.000  243 days 00:41:03   \n",
       "9   2023-11-27 22:10:49.000  2024-06-23 17:45:33.000  208 days 19:34:44   \n",
       "10  2024-07-26 14:26:07.000  2024-07-29 05:12:32.000    2 days 14:46:25   \n",
       "11  2023-06-04 23:49:13.000  2023-12-26 14:57:27.000  204 days 15:08:14   \n",
       "12  2023-09-24 10:47:39.000  2024-02-01 09:39:48.000  129 days 22:52:09   \n",
       "13  2023-01-19 14:38:27.000  2023-11-28 10:44:35.000  312 days 20:06:08   \n",
       "14  2024-01-19 14:06:44.000  2024-04-25 11:42:05.000   96 days 21:35:21   \n",
       "\n",
       "    total_orders  avg_order_rating  num_orders_with_rating  \\\n",
       "0              3          3.666667                       3   \n",
       "1              3          5.000000                       2   \n",
       "2              3          5.000000                       2   \n",
       "3              4          5.000000                       2   \n",
       "4              3          5.000000                       3   \n",
       "5              3          5.000000                       1   \n",
       "6              3          3.500000                       2   \n",
       "7              3          2.666667                       3   \n",
       "8              5          5.000000                       2   \n",
       "9              3          3.000000                       2   \n",
       "10             3          5.000000                       1   \n",
       "11             3          5.000000                       3   \n",
       "12             3          4.000000                       2   \n",
       "13             3          4.666667                       3   \n",
       "14             3          4.000000                       2   \n",
       "\n",
       "    num_canceled_orders  canceled_orders_ratio  total_order_costs  \\\n",
       "0                     0                    0.0            44150.0   \n",
       "1                     0                    0.0            37435.0   \n",
       "2                     0                    0.0            34555.0   \n",
       "3                     0                    0.0            43713.0   \n",
       "4                     0                    0.0            29114.0   \n",
       "5                     0                    0.0            27425.0   \n",
       "6                     0                    0.0            25810.0   \n",
       "7                     0                    0.0            23915.0   \n",
       "8                     0                    0.0            37983.0   \n",
       "9                     0                    0.0            19055.0   \n",
       "10                    0                    0.0            18140.0   \n",
       "11                    0                    0.0            18120.0   \n",
       "12                    0                    0.0            17725.0   \n",
       "13                    0                    0.0            16675.0   \n",
       "14                    0                    0.0            16580.0   \n",
       "\n",
       "    avg_order_cost  num_installment_orders  num_orders_with_promo  \\\n",
       "0         14716.67                       0                      0   \n",
       "1         12478.33                       2                      0   \n",
       "2         11518.33                       0                      0   \n",
       "3         10928.25                       3                      1   \n",
       "4          9704.67                       2                      0   \n",
       "5          9141.67                       3                      0   \n",
       "6          8603.33                       3                      0   \n",
       "7          7971.67                       2                      0   \n",
       "8          7596.60                       2                      0   \n",
       "9          6351.67                       1                      0   \n",
       "10         6046.67                       1                      0   \n",
       "11         6040.00                       3                      0   \n",
       "12         5908.33                       2                      0   \n",
       "13         5558.33                       3                      0   \n",
       "14         5526.67                       3                      0   \n",
       "\n",
       "    used_money_transfer  used_installments  used_cancel  \n",
       "0                     1                  0            0  \n",
       "1                     0                  1            0  \n",
       "2                     1                  0            0  \n",
       "3                     1                  1            0  \n",
       "4                     0                  1            0  \n",
       "5                     0                  1            0  \n",
       "6                     0                  1            0  \n",
       "7                     0                  1            0  \n",
       "8                     1                  1            0  \n",
       "9                     0                  1            0  \n",
       "10                    1                  1            0  \n",
       "11                    0                  1            0  \n",
       "12                    0                  1            0  \n",
       "13                    0                  1            0  \n",
       "14                    0                  1            0  "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "adhoc2 = pd.read_csv('csv/adhoc2.csv')\n",
    "display(adhoc2)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "771462f4",
   "metadata": {},
   "source": [
    "### Выводы по 2 задаче\n",
    "В данной выборке преобладает столица как регион. Рассрочка очень распространена, 13 из 15 клиентов использовали её хотя бы раз.\n",
    "Промокоды практически не влияют, всего 1 заказ с промо. Отмененных заказов в группе нет.\n",
    "Можно сделать фокус на \"высокий чек в столице\", затестить персональные лимиты/условия рассрочки, т.к. она ключевой драйвер."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "1a0d954c",
   "metadata": {},
   "source": [
    "## Задача 3. Статистика по регионам. \n",
    " Для каждого региона подсчитайте:\n",
    " * общее число клиентов и заказов;\n",
    " * среднюю стоимость одного заказа;\n",
    " * долю заказов, которые были куплены в рассрочку;\n",
    " * долю заказов, которые были куплены с использованием промокодов;\n",
    " * долю пользователей, совершивших отмену заказа хотя бы один раз."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "a339beec",
   "metadata": {},
   "outputs": [],
   "source": [
    "SELECT region,\n",
    "       count(DISTINCT user_id) AS total_users,\n",
    "       sum(total_orders) AS total_orders,\n",
    "       avg(total_order_costs / total_orders) AS avg_costs_per_order,\n",
    "       sum(num_installment_orders)::float / sum(total_orders)::float AS installments_ratio,\n",
    "       sum(num_orders_with_promo)::float / sum(total_orders)::float AS promo_ratio,\n",
    "       sum(used_cancel)::float / count(DISTINCT user_id)::float AS cancel_ratio\n",
    "FROM ds_ecom.product_user_features\n",
    "GROUP BY region"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "5e69a3a3",
   "metadata": {},
   "source": [
    "### Результат 3 задачи"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "84b7abb5",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>region</th>\n",
       "      <th>total_users</th>\n",
       "      <th>total_orders</th>\n",
       "      <th>avg_costs_per_order</th>\n",
       "      <th>installments_ratio</th>\n",
       "      <th>promo_ratio</th>\n",
       "      <th>cancel_ratio</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>Москва</td>\n",
       "      <td>39386</td>\n",
       "      <td>40747</td>\n",
       "      <td>3166.438771</td>\n",
       "      <td>0.477262</td>\n",
       "      <td>0.037402</td>\n",
       "      <td>0.006271</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>Новосибирская область</td>\n",
       "      <td>11044</td>\n",
       "      <td>11401</td>\n",
       "      <td>3517.562013</td>\n",
       "      <td>0.541444</td>\n",
       "      <td>0.036751</td>\n",
       "      <td>0.004256</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>Санкт-Петербург</td>\n",
       "      <td>11978</td>\n",
       "      <td>12414</td>\n",
       "      <td>3619.606095</td>\n",
       "      <td>0.546560</td>\n",
       "      <td>0.041647</td>\n",
       "      <td>0.005343</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "                  region  total_users  total_orders  avg_costs_per_order  \\\n",
       "0                 Москва        39386         40747          3166.438771   \n",
       "1  Новосибирская область        11044         11401          3517.562013   \n",
       "2        Санкт-Петербург        11978         12414          3619.606095   \n",
       "\n",
       "   installments_ratio  promo_ratio  cancel_ratio  \n",
       "0            0.477262     0.037402      0.006271  \n",
       "1            0.541444     0.036751      0.004256  \n",
       "2            0.546560     0.041647      0.005343  "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "adhoc3 = pd.read_csv('csv/adhoc3.csv')\n",
    "display(adhoc3)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "b59a9c71",
   "metadata": {},
   "source": [
    "### Выводы по 3 задаче\n",
    "Больше всего пользователей и заказов даёт столица, при этом средний чек по столице меньше чем у остальных регионов.\n",
    "В Москве реже пользуются рассрочкой, чем в остальных регионах. Промокоды в целом используются довольно редко, чаще всего в Питере.\n",
    "Больше всего отмен наблюдается в Москве.\n",
    "\n",
    "У СПБ и Новосиба больше потенциал для роста чека, т.к. выше готовность к рассрочке.\n",
    "Для Москвы подойдут меры для увеличения среднего чека из разряда апселлов/пакетных решений и снижению количества отмен(например коммуникации по доставке/срокам).\n",
    "Предположу, что Москва, будучи \"быстрым\" городом по сравнению с СПБ и Новосибом, ожидает быстрой доставки. Можно затестить новую \"быструю доставку\" и посмотреть как повлияет на метрики."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "63ca4527",
   "metadata": {},
   "source": [
    "## Задача 4. Активность пользователей по первому месяцу заказа в 2023 году\n",
    " Разбейте пользователей на группы в зависимости от того, в какой месяц 2023 года они совершили первый заказ.\n",
    " Для каждой группы посчитайте:\n",
    " * общее количество клиентов, число заказов и среднюю стоимость одного заказа;\n",
    " * средний рейтинг заказа;\n",
    " * долю пользователей, использующих денежные переводы при оплате;\n",
    " * среднюю продолжительность активности пользователя."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "af58184b",
   "metadata": {},
   "outputs": [],
   "source": [
    "SELECT extract(MONTH\n",
    "               FROM first_order_ts) AS MONTH,\n",
    "       count(DISTINCT user_id) AS total_users,\n",
    "       sum(total_orders) AS total_orders,\n",
    "       avg(total_order_costs / total_orders) AS avg_costs,\n",
    "       avg(avg_order_rating) AS avg_rating,\n",
    "       sum(used_money_transfer)::float / count(DISTINCT user_id)::float AS money_transfer_ratio,\n",
    "       avg(lifetime) AS avg_lifetime\n",
    "FROM ds_ecom.product_user_features\n",
    "WHERE extract(YEAR\n",
    "              FROM first_order_ts) = 2023\n",
    "GROUP BY extract(MONTH\n",
    "                 FROM first_order_ts)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "f5fc898a",
   "metadata": {},
   "source": [
    "### Результат 4 задачи"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "2e267d3f",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>month</th>\n",
       "      <th>total_users</th>\n",
       "      <th>total_orders</th>\n",
       "      <th>avg_costs</th>\n",
       "      <th>avg_rating</th>\n",
       "      <th>money_transfer_ratio</th>\n",
       "      <th>avg_lifetime</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>1</td>\n",
       "      <td>465</td>\n",
       "      <td>499</td>\n",
       "      <td>2904.693606</td>\n",
       "      <td>4.175248</td>\n",
       "      <td>0.210753</td>\n",
       "      <td>12 days 19:37:09.617205</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>2</td>\n",
       "      <td>1063</td>\n",
       "      <td>1115</td>\n",
       "      <td>2581.278673</td>\n",
       "      <td>4.168239</td>\n",
       "      <td>0.221072</td>\n",
       "      <td>7 days 00:47:00.06397</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>3</td>\n",
       "      <td>1663</td>\n",
       "      <td>1762</td>\n",
       "      <td>2770.311795</td>\n",
       "      <td>4.185868</td>\n",
       "      <td>0.211064</td>\n",
       "      <td>8 days 03:58:47.521346</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>4</td>\n",
       "      <td>1435</td>\n",
       "      <td>1511</td>\n",
       "      <td>3123.730554</td>\n",
       "      <td>4.140474</td>\n",
       "      <td>0.193728</td>\n",
       "      <td>7 days 01:58:58.324739</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>5</td>\n",
       "      <td>2197</td>\n",
       "      <td>2322</td>\n",
       "      <td>2791.694775</td>\n",
       "      <td>4.222940</td>\n",
       "      <td>0.197997</td>\n",
       "      <td>7 days 16:51:16.78152</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>6</td>\n",
       "      <td>1984</td>\n",
       "      <td>2107</td>\n",
       "      <td>2944.638183</td>\n",
       "      <td>4.185179</td>\n",
       "      <td>0.200101</td>\n",
       "      <td>7 days 12:53:36.892695</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6</th>\n",
       "      <td>7</td>\n",
       "      <td>2463</td>\n",
       "      <td>2604</td>\n",
       "      <td>2795.942069</td>\n",
       "      <td>4.224278</td>\n",
       "      <td>0.206659</td>\n",
       "      <td>6 days 04:54:37.658546</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7</th>\n",
       "      <td>8</td>\n",
       "      <td>2595</td>\n",
       "      <td>2742</td>\n",
       "      <td>2838.273625</td>\n",
       "      <td>4.315146</td>\n",
       "      <td>0.204239</td>\n",
       "      <td>5 days 12:20:18.236224</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>9</td>\n",
       "      <td>2591</td>\n",
       "      <td>2737</td>\n",
       "      <td>3311.923151</td>\n",
       "      <td>4.268803</td>\n",
       "      <td>0.208414</td>\n",
       "      <td>5 days 02:02:35.498263</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>9</th>\n",
       "      <td>10</td>\n",
       "      <td>2832</td>\n",
       "      <td>2954</td>\n",
       "      <td>3254.036507</td>\n",
       "      <td>4.199610</td>\n",
       "      <td>0.209040</td>\n",
       "      <td>3 days 18:11:35.39195</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>10</th>\n",
       "      <td>11</td>\n",
       "      <td>4703</td>\n",
       "      <td>4892</td>\n",
       "      <td>3191.056333</td>\n",
       "      <td>4.002647</td>\n",
       "      <td>0.190091</td>\n",
       "      <td>2 days 09:56:05.941952</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>11</th>\n",
       "      <td>12</td>\n",
       "      <td>3589</td>\n",
       "      <td>3696</td>\n",
       "      <td>3163.727835</td>\n",
       "      <td>4.077451</td>\n",
       "      <td>0.201728</td>\n",
       "      <td>2 days 05:54:20.789357</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "    month  total_users  total_orders    avg_costs  avg_rating  \\\n",
       "0       1          465           499  2904.693606    4.175248   \n",
       "1       2         1063          1115  2581.278673    4.168239   \n",
       "2       3         1663          1762  2770.311795    4.185868   \n",
       "3       4         1435          1511  3123.730554    4.140474   \n",
       "4       5         2197          2322  2791.694775    4.222940   \n",
       "5       6         1984          2107  2944.638183    4.185179   \n",
       "6       7         2463          2604  2795.942069    4.224278   \n",
       "7       8         2595          2742  2838.273625    4.315146   \n",
       "8       9         2591          2737  3311.923151    4.268803   \n",
       "9      10         2832          2954  3254.036507    4.199610   \n",
       "10     11         4703          4892  3191.056333    4.002647   \n",
       "11     12         3589          3696  3163.727835    4.077451   \n",
       "\n",
       "    money_transfer_ratio             avg_lifetime  \n",
       "0               0.210753  12 days 19:37:09.617205  \n",
       "1               0.221072    7 days 00:47:00.06397  \n",
       "2               0.211064   8 days 03:58:47.521346  \n",
       "3               0.193728   7 days 01:58:58.324739  \n",
       "4               0.197997    7 days 16:51:16.78152  \n",
       "5               0.200101   7 days 12:53:36.892695  \n",
       "6               0.206659   6 days 04:54:37.658546  \n",
       "7               0.204239   5 days 12:20:18.236224  \n",
       "8               0.208414   5 days 02:02:35.498263  \n",
       "9               0.209040    3 days 18:11:35.39195  \n",
       "10              0.190091   2 days 09:56:05.941952  \n",
       "11              0.201728   2 days 05:54:20.789357  "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "adhoc4 = pd.read_csv('csv/adhoc4.csv')\n",
    "display(adhoc4)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "d4e86e22",
   "metadata": {},
   "source": [
    "### Выводы по 4 задаче\n",
    "Больше всего пользователей пришло в ноябре, здесь же и большее количество заказов.\n",
    "Средний чек выше к концу года. Больше всего в сентябре, меньше в феврале.\n",
    "Средний рейтинг максимальный так же в сентябре. \n",
    "Денежные переводы как первый тип оплаты использует очень мало пользователей, при этом максимум так же у сентября.\n",
    "Средняя жизнь пользователя от первого до последнего заказа длиннее всего в январе.\n",
    "Осенняя когорта на фоне данных выглядит лучше остальных. Благодаря этому её можно использовать как ориентир для различных кампаний, ведь там выше средний чек и рейтинг.\n",
    "Для ранних зимних-весенних когорт можно тестировать механики удержания, у них ниже чеки и короче активность.\n",
    "Денежные переводы не играют заметной роли, лучше сфокусироваться на рассрочке, если мы ставим целью увеличение среднего чека."
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.13.4"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
